# IRN Revisiting Network Support for RDMA
[SIGCOMM 2018]

## Goal
PFC 给 RoCE 网络带来了很大的问题，且成为了部署大型 RDMA 网络的重要瓶颈。文章通过在现有的 RoCE 协议上作一些涉及到丢包处理的增量修改，使其不需要在网络中配置 PFC （lossless 网络）就可以获得更好的性能。文章还认为，iWARP 的设计思路是有可取之处的，但是 iWARP 的硬件设计导致了复杂的硬件逻辑和高昂的成本，这些问题都可以被 IRN（Improved RoCE NIC）解决。文章还指出，lossless 网络并不是 RDMA 所必须的。

## Overview
在网卡中更为清楚地处理丢包比配置一个 lossless 的网络能发挥更好的性能，但是像 iWARP 那样将整个 TCP 栈用硬件实现并不是有效地处理丢包所必须的。  

key idea：1). 更好的丢包恢复机制；2). 基本的端到端流控，控制 in-flight 的包的数量在 bandwidth-delay product 之下。

丢包恢复：将传统的 go-back-N 机制改为 selective retransmission 选择重传。  
具体而言，任何时候接收端收到一个乱序的包时，它发送一个包含已经累计确认的包的编号（已收到）和一个触发了该 NACK 的包编号的 NACK 信息。发送端在收到 NACK 或定时器超时后进入重传恢复模式，通过 bitmap 跟踪已经累计确认的包和在 NACK 中被选择确认的包，这样它就能确定丢掉的包是哪些，然后进行选择重传。只要没有更高编号的累计确认的 ACK 发回，发送端就会认为这中间的包都是丢掉了的，都会进行重传，直到累计标号高于那个选择确认回来的包编号，此时退出重传恢复模式。  
而对于定时器超时导致的重传，IRN 使用两个定时器参数，当小于 N 个未确认的包在网络中时，IRN 使用一个较小的超时参数，反之使用一个较大的超时参数。

端到端流控：  
由于是在数据中心网络中的，IRN 假定运维人员对于网络拓扑和路由信息都非常清楚，所以 BDP 的设置是静态的。IRN 也并不需要非常精确的 BDP 信息。

与 TCP （以及在硬件上实现 TCP 协议栈的 iWARP）相比，IRN 并不涉及类似 TCP 拥塞控制中那样的滑动窗口，这也就意味着不需要慢启动、AIMD 和快速恢复之类的机制，仅通过 BDP 设置包发送上限即可。另外，直接在 RDMA segment 上操作也省去了使用 TCP 时必须的转译层

主要结果：  

1. IRN 比 RoCE 性能更好。  
2. IRN 不需要 PFC。  
3. RoCE 必须搭配 PFC 使用。  

具体实现上遇到的问题和解决办法：

* 在处理 out-of-order 包时，NIC 的内存不足以存下所有的乱序包。解决办法是，只在 NIC 上存储相关 bitmap，而将包数据直接 DMA 到内存上。  
* 一些 RDMA 算子在第一个包内存储了关键信息，如果发生乱序则收不到，无法处理整个任务（比如 RETH header 存储了远端内存地址的信息）。解决办法是，IRN 将这些信息添加到每一个包的包头。  
* 对于一些 RDMA 算子，需要每个到来的包与 Work Queue Elements（WQE）直接匹配，这在顺序接收的时候被隐式地处理了。这类的算子不多，IRN 对于每一种都有详细的特殊处理办法。

