# BeauCoup Answering Many Network Trafic Queries, One Memory Update at a Time
[SIGCOMM 2020]

## Goal
通过分析一类具有共性的查询方法，基于 coupon collector 模型，在仅使用常数次内存访问的情况下在交换机上支持同时进行多个任务的测量。

## Overview
该论文解决的是一系列可以归约为以下过程的查询算法：对于收到的报文，针对其中的几个参数统计数量（如 srcIP，dstIP 等），其中也可以穿插一些 filter 对某些参数进行过滤（如 TCP SYN 报文统计），当统计的数量超过某一个定值时发送报告。  
coupon collector 模型：对于需要统计的信息，将其 Hash 到 m 个标记中，若标记为空则将之标记上；当被标记的桶总数超过 n 时（$n \le m$）认为已经超过设定的定制，发送报告。其中具体的参数需要根据实际情况进行计算。

key-idea：通过 compiler 计算，将多个测量任务合并，使之对于每一个报文只需要一次（常数次）内存访问就可以满足所有的测量要求。具体到 coupon collector 模型中，即每个报文最多只需要修改一个 coupon （可以不修改任何一个）。

思路本质上是采样。由于交换机的限制，所有的桶的个数和分数都得是 2 的幂。对于每个测量任务都生成哈希（随机值），这第一个值决定对于每个测量任务是否在该报文上执行，决定方法是看生成的哈希值是否在某个区间内（利用交换机的前缀匹配功能加速区间匹配，而具体的区间大小则是根据参数计算出来的，使之满足测量任务期望），如果恰好只有一个任务需要执行则直接测量，若有两个则随机选择其中一个测量，若超过两个则全部不进行（可以证明这种情况出现的概率很低，不会影响最终测量任务的准确率）。对于每个需要测量的任务，则是运行一个上述的 coupon collector 模型。

## Other
这篇文章给出了一个很有用的观察，很多的测量任务都是先对某些 key 作 distinct 运算，然后再做 reduce。  
文章中使用可编程交换机的前缀匹配功能加速随机数的区间匹配，这个做法值得参考。
